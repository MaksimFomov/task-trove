# Алгоритм утверждения исполнителя на заказ

## Описание процесса

Алгоритм описывает полный процесс утверждения исполнителя на заказ в системе Task Trove, начиная с момента просмотра заказчиком откликов исполнителей и заканчивая назначением исполнителя и отправкой уведомлений.

---

## Блок-схема алгоритма

### 1. Начало
**Форма:** Овал  
**Действие:** Начало процесса утверждения исполнителя на заказ

---

### 2. Заказчик открывает страницу деталей заказа
**Форма:** Параллелограмм  
**Действие:** Заказчик переходит на страницу просмотра деталей своего заказа, который находится в статусе "Активен" (ACTIVE) и имеет отклики от исполнителей

---

### 3. Заказчик авторизован?
**Форма:** Ромб (решение)  
**Условие:** Система проверяет наличие активной сессии пользователя с ролью "Customer" (проверка происходит через ProtectedRoute)

**Если НЕТ:**
- Переход к шагу 4

**Если ДА:**
- Переход к шагу 5

---

### 4. Перенаправление на страницу входа
**Форма:** Параллелограмм  
**Действие:** Система перенаправляет пользователя на страницу входа для авторизации

**После авторизации:**
- Переход к шагу 5

---

### 5. Система загружает данные о заказе и откликах исполнителей
**Форма:** Прямоугольник  
**Действие:** Система:
- Загружает информацию о заказе (название, описание, статус, заказчик)
- Загружает список всех откликов на этот заказ
- Для каждого отклика загружает информацию об исполнителе (имя, email, портфолио)

---

### 6. Заказчик просматривает список откликов
**Форма:** Параллелограмм  
**Действие:** Заказчик видит список всех исполнителей, которые откликнулись на его заказ. Для каждого исполнителя отображается:
- Имя исполнителя
- Email исполнителя
- Кнопка "Просмотреть профиль"
- Кнопка "Одобрить"

---

### 7. Заказчик выбирает исполнителя для просмотра профиля (опционально)
**Форма:** Параллелограмм  
**Действие:** Заказчик может нажать кнопку "Просмотреть профиль" для изучения:
- Портфолио исполнителя
- Выполненных заказов исполнителя
- Отзывов о работе исполнителя

**После просмотра:**
- Возврат к шагу 6 или переход к шагу 8

---

### 8. Заказчик нажимает "Одобрить" у выбранного исполнителя
**Форма:** Параллелограмм  
**Действие:** Заказчик подтверждает выбор исполнителя, нажимая кнопку "Одобрить" рядом с выбранным исполнителем

---

### 9. Система открывает модальное окно подтверждения
**Форма:** Прямоугольник  
**Действие:** Система отображает модальное окно с запросом подтверждения выбора исполнителя

---

### 10. Заказчик подтверждает выбор исполнителя
**Форма:** Параллелограмм  
**Действие:** Заказчик подтверждает заявку, нажимая кнопку подтверждения в модальном окне

---

### 11. Система проверяет, что заказ принадлежит заказчику
**Форма:** Прямоугольник  
**Действие:** Система проверяет, что ID заказчика из токена совпадает с ID заказчика заказа

**Если проверка не пройдена:**
- Система возвращает ошибку "Доступ запрещен"
- Процесс завершается

**Если проверка пройдена:**
- Переход к шагу 12

---

### 12. Система проверяет наличие отклика от выбранного исполнителя
**Форма:** Прямоугольник  
**Действие:** Система проверяет, что у выбранного исполнителя есть отклик на этот заказ

**Если отклик не найден:**
- Система возвращает ошибку "Отклик от исполнителя не найден"
- Процесс завершается

**Если отклик найден:**
- Переход к шагу 13

---

### 13. Система удаляет все остальные отклики и отправляет уведомления об отказе другим исполнителям
**Форма:** Прямоугольник  
**Действие:** Система:
- Находит все отклики на этот заказ, кроме отклика выбранного исполнителя
- Для каждого отклика другого исполнителя:
  - Создаёт уведомление типа "PERFORMER_NOT_SELECTED" для исполнителя
  - Удаляет отклик из базы данных
- Уведомление содержит: название заказа, имя заказчика, информацию о том, что заказчик выбрал другого исполнителя

---

### 14. Система устанавливает флаг одобрения для отклика выбранного исполнителя
**Форма:** Прямоугольник  
**Действие:** Система:
- Перезагружает отклик выбранного исполнителя из базы данных
- Устанавливает флаг `isApprovedByCustomer = true` для этого отклика
- Сохраняет изменения в базе данных

---

### 15. Система назначает исполнителя на заказ и устанавливает статус "В работе" (IN_PROCESS)
**Форма:** Прямоугольник  
**Действие:** Система:
- Перезагружает заказ из базы данных
- Устанавливает исполнителя (performer) для заказа
- Изменяет статус заказа на `IN_PROCESS`
- Сохраняет изменения в базе данных

---

### 16. Система создаёт чат между заказчиком и исполнителем (если его ещё нет)
**Форма:** Прямоугольник  
**Действие:** Система:
- Проверяет, существует ли уже чат между этим заказчиком и исполнителем
- Если чат не существует:
  - Создаёт новый чат с названием "Order #[ID]: [Название заказа]"
  - Устанавливает флаги проверки сообщений: `checkByCustomer = false`, `checkByPerformer = false`
  - Устанавливает флаги удаления: `deletedByCustomer = false`, `deletedByPerformer = false`
- Если чат существует, но был удалён:
  - Восстанавливает чат (сбрасывает флаги удаления)
  - Обновляет название чата

---

### 17. Система отправляет уведомление исполнителю о принятии в работу
**Форма:** Прямоугольник  
**Действие:** Система:
- Создаёт уведомление типа "ASSIGNED" для исполнителя
- Уведомление содержит: название заказа, имя заказчика, информацию о том, что заказчик принял исполнителя в работу

---

### 18. Исполнитель получает уведомление о принятии в работу
**Форма:** Параллелограмм  
**Действие:** Исполнитель видит уведомление в системе о том, что заказчик принял его в работу по заказу. Исполнитель может начинать выполнение заказа.

---

### 19. Система отображает сообщение об успехе и обновляет данные заказа
**Форма:** Параллелограмм  
**Действие:** Система:
- Отображает сообщение "Исполнитель одобрен"
- Обновляет данные заказа в интерфейсе
- Обновляет список заказов
- Обновляет список откликов исполнителя

---

### 20. Конец
**Форма:** Овал  
**Действие:** Завершение процесса утверждения исполнителя на заказ

---

## Статусы заказа в процессе

- **ACTIVE** - Заказ активен и доступен для откликов исполнителей (начальное состояние)
- **IN_PROCESS** - Заказ в работе (исполнитель назначен, статус устанавливается после утверждения)

---

## Дополнительные сценарии

### Сценарий: Отказ от исполнителя
Если заказчик хочет отказаться от назначенного исполнителя:
1. Заказчик нажимает кнопку "Отказаться от исполнителя"
2. Система подтверждает действие
3. Система удаляет все отклики для этого заказа
4. Система снимает назначение исполнителя (performer = null)
5. Статус заказа возвращается в `ACTIVE`
6. Исполнители могут снова откликнуться на заказ
7. Исполнитель получает уведомление об отказе

---

## Примечания

- Все уведомления сохраняются в базе данных и отображаются в интерфейсе пользователя
- Заказчик может просмотреть профиль исполнителя перед утверждением
- После утверждения исполнителя все остальные отклики удаляются, и другие исполнители получают уведомления об отказе
- Чат создаётся автоматически при назначении исполнителя и используется для общения между заказчиком и исполнителем
- После назначения исполнителя заказ переходит в статус "В работе" и больше не доступен для откликов других исполнителей

