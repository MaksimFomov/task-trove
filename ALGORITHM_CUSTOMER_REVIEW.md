# Алгоритм оставления заказчиком отзыва исполнителю

## Описание процесса

Алгоритм описывает полный процесс оставления заказчиком отзыва об исполнителе в системе Task Trove, начиная с момента открытия страницы завершённого заказа и заканчивая отправкой уведомления исполнителю.

---

## Блок-схема алгоритма

### 1. Начало
**Форма:** Овал  
**Действие:** Начало процесса оставления отзыва заказчиком исполнителю

---

### 2. Заказчик открывает страницу деталей завершённого заказа
**Форма:** Параллелограмм  
**Действие:** Заказчик переходит на страницу просмотра деталей своего заказа, который находится в статусе "Выполнен" (DONE) и имеет назначенного исполнителя

---

### 3. Заказчик авторизован?
**Форма:** Ромб (решение)  
**Условие:** Система проверяет наличие активной сессии пользователя с ролью "Customer" (проверка происходит через ProtectedRoute)

**Если НЕТ:**
- Переход к шагу 4

**Если ДА:**
- Переход к шагу 5

---

### 4. Перенаправление на страницу входа
**Форма:** Параллелограмм  
**Действие:** Система перенаправляет пользователя на страницу входа для авторизации

**После авторизации:**
- Переход к шагу 5

---

### 5. Система загружает данные о заказе
**Форма:** Прямоугольник  
**Действие:** Система:
- Загружает информацию о заказе (название, описание, статус, заказчик, исполнитель)
- Проверяет, что заказ находится в статусе `DONE`
- Проверяет, что у заказа есть назначенный исполнитель

---

### 6. Заказчик видит заказ со статусом "Выполнен" и кнопку "Оставить отзыв"
**Форма:** Параллелограмм  
**Действие:** Заказчик видит информацию о завершённом заказе и кнопку "Оставить отзыв" (кнопка отображается только если заказ завершён и имеет исполнителя)

---

### 7. Заказчик нажимает "Оставить отзыв"
**Форма:** Параллелограмм  
**Действие:** Заказчик подтверждает заявку, нажимая кнопку "Оставить отзыв"

---

### 8. Система открывает модальное окно с формой отзыва
**Форма:** Прямоугольник  
**Действие:** Система:
- Отображает модальное окно с формой отзыва
- Устанавливает ID исполнителя из заказа в данные формы
- Инициализирует оценку по умолчанию: 5 звёзд
- Инициализирует текст отзыва: пустая строка

---

### 9. Заказчик вводит данные отзыва
**Форма:** Параллелограмм  
**Действие:** Заказчик заполняет форму отзыва:
- Выбирает оценку (от 1 до 5 звёзд) путём нажатия на звёзды
- Вводит текст отзыва (комментарий) в текстовое поле

---

### 10. Заказчик нажимает "Отправить отзыв"
**Форма:** Параллелограмм  
**Действие:** Заказчик подтверждает отправку отзыва, нажимая кнопку "Отправить отзыв"

---

### 11. Система проверяет корректность введённых данных
**Форма:** Прямоугольник  
**Действие:** Система выполняет валидацию данных на клиенте:
- Проверка наличия ID исполнителя
- Проверка наличия оценки (должна быть от 1 до 5)
- Проверка наличия заказа

**Если данные некорректны:**
- Система отображает ошибку
- Процесс завершается

**Если данные корректны:**
- Переход к шагу 12

---

### 12. Система отправляет данные отзыва на сервер
**Форма:** Прямоугольник  
**Действие:** Система отправляет запрос на сервер с данными:
- Имя заказчика
- Оценка (mark, от 1 до 5)
- Текст отзыва (text)
- ID исполнителя (performerId)
- ID заказа (orderId)

---

### 13. Система проверяет, что заказ существует и завершён
**Форма:** Прямоугольник  
**Действие:** Система:
- Находит заказ по ID в базе данных
- Проверяет, что статус заказа равен `DONE`

**Если заказ не найден или не завершён:**
- Система возвращает ошибку "Невозможно оставить отзыв для незавершённого заказа"
- Процесс завершается

**Если проверка пройдена:**
- Переход к шагу 14

---

### 14. Система проверяет, что заказ принадлежит заказчику
**Форма:** Прямоугольник  
**Действие:** Система проверяет, что ID заказчика из токена совпадает с ID заказчика заказа

**Если проверка не пройдена:**
- Система возвращает ошибку "Доступ запрещён к заказу"
- Процесс завершается

**Если проверка пройдена:**
- Переход к шагу 15

---

### 15. Система проверяет, что у заказа есть исполнитель
**Форма:** Прямоугольник  
**Действие:** Система проверяет, что у заказа назначен исполнитель (performer не равен null)

**Если исполнитель не назначен:**
- Система возвращает ошибку "У заказа нет назначенного исполнителя"
- Процесс завершается

**Если проверка пройдена:**
- Переход к шагу 16

---

### 16. Система сохраняет отзыв в базе данных
**Форма:** Прямоугольник  
**Действие:** Система:
- Создаёт запись отзыва (WorkExperience) в базе данных
- Устанавливает заказчика (customer) из токена
- Устанавливает исполнителя (performer) из заказа
- Устанавливает тип рецензента (reviewerType): `CUSTOMER`
- Устанавливает заказ (order)
- Устанавливает оценку (rate) из данных формы
- Устанавливает текст отзыва (text) из данных формы
- Устанавливает имя (name) заказчика
- Сохраняет отзыв в базе данных

---

### 17. Система отправляет уведомление исполнителю о том, что его оценили
**Форма:** Прямоугольник  
**Действие:** Система:
- Создаёт уведомление типа "REVIEW" для исполнителя
- Уведомление содержит: название заказа, имя заказчика, оценку (mark), информацию о том, что заказчик оставил отзыв

---

### 18. Исполнитель получает уведомление о том, что его оценили
**Форма:** Параллелограмм  
**Действие:** Исполнитель видит уведомление в системе о том, что заказчик оставил ему отзыв с оценкой. Исполнитель может просмотреть отзыв в своём профиле.

---

### 19. Система отображает сообщение об успехе и обновляет данные
**Форма:** Параллелограмм  
**Действие:** Система:
- Отображает сообщение "Отзыв добавлен"
- Закрывает модальное окно формы отзыва
- Сбрасывает данные формы (оценка: 5, текст: пустая строка)
- Обновляет список отзывов исполнителя в интерфейсе
- Обновляет все связанные запросы для отображения актуальных данных

---

### 20. Конец
**Форма:** Овал  
**Действие:** Завершение процесса оставления отзыва заказчиком исполнителю

---

## Статусы заказа

- **DONE** - Заказ выполнен (необходимое условие для оставления отзыва)

---

## Дополнительные сценарии

### Сценарий: Отзыв без указания заказа
Если заказчик хочет оставить отзыв исполнителю без привязки к конкретному заказу:
1. Заказчик указывает только ID исполнителя (без orderId)
2. Система проверяет наличие ID исполнителя
3. Система находит исполнителя по ID
4. Система сохраняет отзыв без привязки к заказу
5. Уведомление отправляется исполнителю

**Примечание:** В текущей реализации отзыв обычно привязан к завершённому заказу.

---

## Примечания

- Все уведомления сохраняются в базе данных и отображаются в интерфейсе пользователя
- Заказчик может оставить отзыв только для завершённых заказов (статус DONE)
- Оценка должна быть от 1 до 5 звёзд
- Текст отзыва опционален, но рекомендуется для более полной оценки
- Отзыв автоматически связывается с заказом и исполнителем
- Исполнитель получает уведомление о новом отзыве с указанием оценки
- Отзывы отображаются в профиле исполнителя и помогают другим заказчикам при выборе

